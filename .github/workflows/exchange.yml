name: Exchange Clock (Hourly)

on:
  schedule:
    # minute 07 during UTC window that overlaps US market hours; Python guard enforces America/Chicago hours
    - cron: "7 15-22 * * 1-5"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

concurrency:
  group: "exchange-clock"
  cancel-in-progress: false

jobs:
  tick:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main (code)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout exchange-data (persistent state)
        uses: actions/checkout@v4
        with:
          ref: exchange-data
          path: exchange_state
          fetch-depth: 0

      - name: Sync persistent state into workspace
        shell: bash
        run: |
          set -e
          mkdir -p data/market data/state data/reports data/leaderboards site/data
          if [ -d "exchange_state/data" ]; then
            rsync -a exchange_state/data/ data/ || true
          fi
          if [ -d "exchange_state/site" ]; then
            rsync -a exchange_state/site/ site/ || true
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install numpy pandas pyyaml
          fi

      - name: Fetch open order issues -> tmp_issues.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            async function listAllIssues() {
              const issues = [];
              for await (const response of github.paginate.iterator(
                github.rest.issues.listForRepo,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'order',
                  per_page: 100
                }
              )) {
                issues.push(...response.data);
              }
              return issues;
            }

            const raw = await listAllIssues();
            // Filter out PRs (PRs have pull_request field)
            const issues = raw.filter(x => !x.pull_request);

            fs.writeFileSync('tmp_issues.json', JSON.stringify({ issues }, null, 2), 'utf8');
            core.info(`Fetched ${issues.length} order issues`);

      - name: Run exchange tick (generate bar + execute orders + write snapshots)
        shell: bash
        run: |
          python -m simulator.run_github_exchange_tick --orders_json tmp_issues.json

      - name: Close processed order issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const obj = JSON.parse(fs.readFileSync('tmp_issues.json', 'utf8'));
            const issues = obj.issues || [];

            core.info(`Closing ${issues.length} order issues...`);
            for (const it of issues) {
              const number = it.number;
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                state: "closed"
              });
            }

      - name: Sync updated state back to exchange-data working tree
        shell: bash
        run: |
          set -e
          mkdir -p exchange_state/data exchange_state/site
          rsync -a data/ exchange_state/data/
          rsync -a site/ exchange_state/site/

      - name: Commit & push state to exchange-data
        shell: bash
        run: |
          set -e
          cd exchange_state
          git config user.name "exchange-bot"
          git config user.email "exchange-bot@users.noreply.github.com"

          # Force add state/site even if ignored on main
          git add -A -f data site
          if git diff --cached --quiet; then
            echo "No state changes to commit."
          else
            git commit -m "Exchange tick: update state and snapshots"
            git push
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: exchange_state/site

  deploy:
    needs: tick
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
